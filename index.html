<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>렌탈 견적 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tabs {
            background: #f8f9fa;
            padding: 0;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        
        .tab:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        
        .tab-panel {
            display: none;
            padding: 20px;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .filters-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-group h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
        }
        
        .checkbox-group label:hover {
            background: #f0f0f0;
            border-color: #764ba2;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"]:checked + span {
            color: #764ba2;
            font-weight: 600;
        }
        
        .search-section {
            margin-bottom: 20px;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #764ba2;
        }
        
        .search-btn, .copy-all-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
        }
        
        .search-btn:hover, .copy-all-btn:hover {
            transform: translateY(-2px);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #764ba2;
        }
        
        .product-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .product-header h3 {
            color: #333;
            margin-bottom: 8px;
        }
        
        .product-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .product-badges span {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .stand-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .water-only-badge {
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            color: white;
        }
        
        .cold-water-badge {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .tag-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }
        
        .product-info {
            margin-bottom: 15px;
        }
        
        .product-info p {
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .product-info strong {
            color: #333;
        }
        
        .rental-options {
            margin-top: 15px;
        }
        
        .rental-option {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .rental-option:hover {
            background: #e8e9ea;
        }
        
        .option-info {
            flex: 1;
        }
        
        .option-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .option-details {
            font-size: 13px;
            color: #666;
        }
        
        .copy-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .copy-btn:hover {
            transform: scale(1.05);
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #f44336, #da190b);
        }
        
        .product-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .input-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .input-section textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .input-section textarea:focus {
            outline: none;
            border-color: #764ba2;
        }
        
        .save-btn {
            margin-top: 15px;
            padding: 12px 40px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.3s;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
        }
        
        /* 태그 관리 스타일 */
        .tags-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .tags-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .tags-header h2 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .tag-input-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .tag-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: end;
        }
        
        .tag-input-group {
            position: relative;
        }
        
        .tag-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .tag-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .search-suggestions.active {
            display: block;
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .tag-add-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .tag-add-btn:hover {
            transform: translateY(-2px);
        }
        
        .product-tags-list {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .product-tags-list h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .tagged-product-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tagged-product-info {
            flex: 1;
        }
        
        .product-model {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .product-name {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .product-tag-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .product-tag-badges .tag-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .tag-remove {
            cursor: pointer;
            color: #666;
            font-weight: bold;
        }
        
        .tag-remove:hover {
            color: #ff4444;
        }
        
        /* 브랜드 유의사항 스타일 */
        .notes-container, .competitor-rules-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .notes-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .notes-header h2 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .notes-grid, .competitor-rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .note-card, .competitor-rule-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .note-header, .competitor-rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .note-brand, .competitor-rule-brand {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }
        
        .note-updated {
            font-size: 12px;
            color: #999;
        }
        
        .note-content, .competitor-rule-content {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        
        .save-notes-btn, .save-competitor-btn {
            display: block;
            margin: 0 auto;
            padding: 12px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .save-notes-btn:hover, .save-competitor-btn:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 렌탈 견적 시스템</h1>
            <p>효율적인 렌탈 상품 관리 및 견적 생성 도구</p>
        </div>
        
        <div class="tabs">
            <div class="tabs-container">
                <button class="tab active" onclick="switchTab('output')">📋 견적 출력</button>
                <button class="tab" onclick="switchTab('input')">✏️ 견적 입력</button>
                <button class="tab" onclick="switchTab('tags')">🏷️ 태그 관리</button>
                <button class="tab" onclick="switchTab('notes')">📌 브랜드 유의사항</button>
                <button class="tab" onclick="switchTab('competitor')">🔄 타사보상 규정</button>
            </div>
        </div>
        
        <!-- 견적 출력 탭 -->
        <div id="output-panel" class="tab-panel active">
            <div class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="모델명, 제품명, 브랜드, 태그로 검색..." onkeyup="searchProducts()">
                    <button class="search-btn" onclick="searchProducts()">🔍 검색</button>
                    <button class="copy-all-btn" onclick="copyAllFiltered()">📋 전체복사</button>
                </div>
                <div class="product-summary" id="productSummary">
                    <span>전체 제품: <strong id="totalCount">0</strong>개</span>
                    <span>검색 결과: <strong id="filteredCount">0</strong>개</span>
                </div>
            </div>
            
            <div class="filters-section">
                <div class="filter-group">
                    <h3>📅 렌탈 기간</h3>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="year3" checked>
                            <span>3년 약정</span>
                        </label>
                        <label>
                            <input type="checkbox" id="year5" checked>
                            <span>5년 약정</span>
                        </label>
                        <label>
                            <input type="checkbox" id="year6" checked>
                            <span>6년 약정</span>
                        </label>
                    </div>
                </div>
                
                <div class="filter-group">
                    <h3>🔧 관리 방식</h3>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="manage4" checked>
                            <span>4개월 관리</span>
                        </label>
                        <label>
                            <input type="checkbox" id="manage2" checked>
                            <span>2개월 관리</span>
                        </label>
                        <label>
                            <input type="checkbox" id="filterSend" checked>
                            <span>필터발송</span>
                        </label>
                    </div>
                </div>
                
                <div class="filter-group">
                    <h3>🎯 타사보상</h3>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="hideCompetitor">
                            <span>타사보상 숨기기</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="products-grid" id="productsGrid">
                <div class="loading">데이터를 불러오는 중...</div>
            </div>
        </div>
        
        <!-- 견적 입력 탭 -->
        <div id="input-panel" class="tab-panel">
            <div class="input-section">
                <h2>📝 CRM 데이터 입력</h2>
                <p style="margin-bottom: 15px; color: #666;">CRM에서 복사한 제품 정보를 아래에 붙여넣으세요</p>
                <textarea id="crmInput" placeholder="예시:
* 모델명: WPUIAC425S
* 제품명: SK매직 원코크 플러스 얼음물 냉온정수기 (얼음냉온정)

* 3년약정: 4개월관리 / 월 55,900 / 사은품 180,000
* 5년약정: 6M반값_4개월관리 / 월 50,400 / 사은품 330,000

상품 안내페이지 : https://zero-rental.biz/product-image/51317"></textarea>
                <button class="save-btn" onclick="saveProduct()">💾 제품 저장</button>
            </div>
        </div>
        
        <!-- 태그 관리 탭 -->
        <div id="tags-panel" class="tab-panel">
            <div class="tags-container">
                <div class="tags-header">
                    <h2>🏷️ 태그 관리 시스템</h2>
                    <p>상품에 커스텀 태그를 추가하여 분류하고 검색할 수 있습니다</p>
                </div>
                
                <div class="tag-input-section">
                    <div class="tag-input-grid">
                        <div class="tag-input-group">
                            <label>모델명/상품명 입력해서 선택하고</label>
                            <input type="text" id="productSearchInput" placeholder="모델명 또는 상품명 검색..." 
                                   onkeyup="searchProductsForTag()" onfocus="searchProductsForTag()">
                            <div id="productSearchSuggestions" class="search-suggestions"></div>
                        </div>
                        <div class="tag-input-group">
                            <label>붙이고 싶은 태그(예: 가성비)를 붙여주세요</label>
                            <input type="text" id="tagInput" placeholder="태그명 입력...">
                        </div>
                        <button class="tag-add-btn" onclick="addTagToProduct()">✨ 태그 추가</button>
                    </div>
                </div>
                
                <div class="product-tags-list">
                    <h3>📌 태그가 붙은 상품들</h3>
                    <div id="taggedProductsList">
                        <!-- 태그가 붙은 상품 목록이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 브랜드 유의사항 탭 -->
        <div id="notes-panel" class="tab-panel">
            <div class="notes-container">
                <div class="notes-header">
                    <h2>📌 브랜드별 유의사항</h2>
                    <p>각 브랜드의 렌탈 진행 시 주의사항을 기록해주세요</p>
                </div>
                <div class="notes-grid">
                    <!-- 유의사항 카드들이 동적으로 생성됩니다 -->
                </div>
                <button class="save-notes-btn" onclick="saveNotes()">💾 유의사항 저장</button>
            </div>
        </div>
        
        <!-- 타사보상 규정 탭 -->
        <div id="competitor-panel" class="tab-panel">
            <div class="competitor-rules-container">
                <div class="notes-header">
                    <h2>🔄 브랜드별 타사보상 규정</h2>
                    <p>각 브랜드의 타사보상 프로모션 규정과 조건을 기록해주세요</p>
                </div>
                <div class="competitor-rules-grid">
                    <!-- 타사보상 규정 카드들이 동적으로 생성됩니다 -->
                </div>
                <button class="save-competitor-btn" onclick="saveCompetitorRules()">💾 타사보상 규정 저장</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://luxzmdcpobdecpfmdmjs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eHptZGNwb2JkZWNwZm1kbWpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQxNTA0NTUsImV4cCI6MjA0OTcyNjQ1NX0.6Fb4cd_Hc4O-3FenNXALBMzD2-qrYbA6lMgH8HGIZGY';
        
        let products = [];
        let productTags = {};
        let selectedProductForTag = null;
        
        // 탭 전환 함수
        function switchTab(tabName) {
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 모든 패널 숨기기
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + '-panel').classList.add('active');
            
            // 각 탭별 초기화
            if (tabName === 'output') {
                renderProducts(products);
            } else if (tabName === 'tags') {
                updateTaggedProductsList();
            } else if (tabName === 'notes') {
                loadNotesUI();
            } else if (tabName === 'competitor') {
                loadCompetitorUI();
            }
        }
        
        // 토스트 메시지 표시
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // 제품 렌더링
        function renderProducts(productList) {
            const grid = document.getElementById('productsGrid');
            
            if (!productList || productList.length === 0) {
                grid.innerHTML = '<div class="loading">제품이 없습니다.</div>';
                return;
            }
            
            // 필터 설정 가져오기
            const filters = {
                year3: document.getElementById('year3').checked,
                year5: document.getElementById('year5').checked,
                year6: document.getElementById('year6').checked,
                manage4: document.getElementById('manage4').checked,
                manage2: document.getElementById('manage2').checked,
                filterSend: document.getElementById('filterSend').checked,
                hideCompetitor: document.getElementById('hideCompetitor').checked
            };
            
            grid.innerHTML = productList.map(product => {
                try {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    
                    // 제품 타입 체크
                    const isStand = product.name && product.name.includes('스탠드');
                    const isWaterOnly = product.name && (product.name.includes('(정수)') || product.name.includes('(정수전용)'));
                    const isColdWater = product.name && product.name.includes('냉정수기');
                    
                    // 배지 생성
                    let badges = '';
                    if (isStand) badges += '<span class="stand-badge">🏢 스탠드</span>';
                    if (isWaterOnly) badges += '<span class="water-only-badge">💧 정수전용</span>';
                    if (isColdWater) badges += '<span class="cold-water-badge">❄️💧 냉정수기</span>';
                    
                    // 커스텀 태그 추가
                    const customTags = productTags[product.model] || [];
                    const customTagsHtml = customTags.map(tag => 
                        `<span class="tag-badge">✨ ${tag}</span>`
                    ).join('');
                    
                    productCard.innerHTML = `
                        <div class="product-header">
                            <h3>${product.model}</h3>
                            <div class="product-badges">
                                ${badges}
                                ${customTagsHtml}
                            </div>
                        </div>
                        <div class="product-info">
                            <p><strong>${product.name}</strong></p>
                            <p>브랜드: ${product.brand}</p>
                            ${product.url ? `<p><a href="${product.url}" target="_blank">🔗 상품 페이지</a></p>` : ''}
                        </div>
                        <div class="rental-options">
                            ${generateOptions(product, filters)}
                        </div>
                    `;
                    
                    return productCard.outerHTML;
                } catch (error) {
                    console.error('제품 렌더링 오류:', error, product);
                    return '';
                }
            }).join('');
            
            updateProductSummary();
        }
        
        // 옵션 생성
        function generateOptions(product, filters) {
            let optionsHtml = '';
            
            if (!product.options) return '<p>옵션 정보가 없습니다.</p>';
            
            product.options.forEach(option => {
                // 필터링 로직
                const yearMatch = (option.period === '3년약정' && filters.year3) ||
                                 (option.period === '5년약정' && filters.year5) ||
                                 (option.period === '6년약정' && filters.year6);
                
                if (!yearMatch) return;
                
                const isCompetitor = option.management && option.management.includes('타사보상');
                if (filters.hideCompetitor && isCompetitor) return;
                
                const manageMatch = (option.management && option.management.includes('4개월') && filters.manage4) ||
                                   (option.management && option.management.includes('2개월') && filters.manage2) ||
                                   (option.management && option.management.includes('필터발송') && filters.filterSend);
                
                if (!manageMatch) return;
                
                optionsHtml += `
                    <div class="rental-option">
                        <div class="option-info">
                            <div class="option-title">${option.period}</div>
                            <div class="option-details">
                                ${option.management} | 월 ${option.price ? option.price.toLocaleString() : '0'}원
                                ${option.gift ? ` | 사은품 ${option.gift.toLocaleString()}원` : ''}
                            </div>
                        </div>
                        <button class="copy-btn" onclick="copyOption('${product.model}', '${product.name}', '${option.period}', '${option.management}', ${option.price}, ${option.gift || 0})">복사</button>
                    </div>
                `;
            });
            
            return optionsHtml || '<p>선택된 필터에 해당하는 옵션이 없습니다.</p>';
        }
        
        // 옵션 복사
        function copyOption(model, name, period, management, price, gift) {
            const text = `* 모델명: ${model}
* 제품명: ${name}

* ${period}: ${management} / 월 ${price.toLocaleString()} / 사은품 ${gift.toLocaleString()}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('견적이 복사되었습니다!', 'success');
            });
        }
        
        // 전체 복사 (필터 적용)
        function copyAllFiltered() {
            const filters = {
                year3: document.getElementById('year3').checked,
                year5: document.getElementById('year5').checked,
                year6: document.getElementById('year6').checked,
                manage4: document.getElementById('manage4').checked,
                manage2: document.getElementById('manage2').checked,
                filterSend: document.getElementById('filterSend').checked,
                hideCompetitor: document.getElementById('hideCompetitor').checked
            };
            
            let allText = '';
            let copiedCount = 0;
            
            products.forEach(product => {
                let productText = '';
                let hasOptions = false;
                
                product.options.forEach(option => {
                    const yearMatch = (option.period === '3년약정' && filters.year3) ||
                                     (option.period === '5년약정' && filters.year5) ||
                                     (option.period === '6년약정' && filters.year6);
                    
                    if (!yearMatch) return;
                    
                    const isCompetitor = option.management && option.management.includes('타사보상');
                    if (filters.hideCompetitor && isCompetitor) return;
                    
                    const manageMatch = (option.management && option.management.includes('4개월') && filters.manage4) ||
                                       (option.management && option.management.includes('2개월') && filters.manage2) ||
                                       (option.management && option.management.includes('필터발송') && filters.filterSend);
                    
                    if (!manageMatch) return;
                    
                    if (!hasOptions) {
                        productText = `* 모델명: ${product.model}\n* 제품명: ${product.name}\n\n`;
                        hasOptions = true;
                    }
                    
                    productText += `* ${option.period}: ${option.management} / 월 ${option.price.toLocaleString()} / 사은품 ${option.gift ? option.gift.toLocaleString() : 0}\n`;
                    copiedCount++;
                });
                
                if (hasOptions) {
                    allText += productText + '\n---\n\n';
                }
            });
            
            if (allText) {
                navigator.clipboard.writeText(allText).then(() => {
                    showToast(`${copiedCount}개 옵션이 복사되었습니다!`, 'success');
                });
            } else {
                showToast('복사할 옵션이 없습니다.', 'error');
            }
        }
        
        // 통합 검색 함수
        function searchProducts() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchValue) {
                renderProducts(products);
                return;
            }
            
            const filtered = products.filter(product => {
                // 모델명, 제품명, 브랜드로 검색
                const basicMatch = product.model.toLowerCase().includes(searchValue) ||
                       product.name.toLowerCase().includes(searchValue) ||
                       product.brand.toLowerCase().includes(searchValue);
                
                // 태그로 검색
                const tags = productTags[product.model] || [];
                const tagMatch = tags.some(tag => tag.toLowerCase().includes(searchValue));
                
                return basicMatch || tagMatch;
            });
            
            renderProducts(filtered);
        }
        
        // 제품 요약 업데이트
        function updateProductSummary() {
            const totalCount = document.getElementById('totalCount');
            const filteredCount = document.getElementById('filteredCount');
            
            totalCount.textContent = products.length;
            
            const visibleCards = document.querySelectorAll('.product-card').length;
            filteredCount.textContent = visibleCards;
        }
        
        // 태그 관리 함수들
        function searchProductsForTag() {
            const searchValue = document.getElementById('productSearchInput').value.toLowerCase();
            const suggestionsDiv = document.getElementById('productSearchSuggestions');
            
            if (searchValue.length < 2) {
                suggestionsDiv.classList.remove('active');
                return;
            }
            
            const matches = products.filter(p => 
                p.model.toLowerCase().includes(searchValue) || 
                p.name.toLowerCase().includes(searchValue)
            ).slice(0, 10);
            
            if (matches.length > 0) {
                suggestionsDiv.innerHTML = matches.map(p => `
                    <div class="suggestion-item" onclick="selectProductForTag('${p.model}', '${p.name.replace(/'/g, "\\'")}')">
                        <strong>${p.model}</strong> - ${p.name}
                    </div>
                `).join('');
                suggestionsDiv.classList.add('active');
            } else {
                suggestionsDiv.classList.remove('active');
            }
        }
        
        function selectProductForTag(model, name) {
            selectedProductForTag = { model, name };
            document.getElementById('productSearchInput').value = `${model} - ${name}`;
            document.getElementById('productSearchSuggestions').classList.remove('active');
        }
        
        function addTagToProduct() {
            if (!selectedProductForTag) {
                showToast('상품을 먼저 선택해주세요', 'error');
                return;
            }
            
            const tagName = document.getElementById('tagInput').value.trim();
            if (!tagName) {
                showToast('태그명을 입력해주세요', 'error');
                return;
            }
            
            const productKey = selectedProductForTag.model;
            if (!productTags[productKey]) {
                productTags[productKey] = [];
            }
            
            if (!productTags[productKey].includes(tagName)) {
                productTags[productKey].push(tagName);
                localStorage.setItem('productTags', JSON.stringify(productTags));
                
                // 입력 필드 초기화
                document.getElementById('productSearchInput').value = '';
                document.getElementById('tagInput').value = '';
                selectedProductForTag = null;
                
                updateTaggedProductsList();
                showToast(`"${tagName}" 태그가 추가되었습니다`, 'success');
            } else {
                showToast('이미 존재하는 태그입니다', 'error');
            }
        }
        
        function removeTagFromProduct(model, tag) {
            if (productTags[model]) {
                productTags[model] = productTags[model].filter(t => t !== tag);
                if (productTags[model].length === 0) {
                    delete productTags[model];
                }
                localStorage.setItem('productTags', JSON.stringify(productTags));
                updateTaggedProductsList();
                renderProducts(products); // 메인 화면 업데이트
                showToast('태그가 삭제되었습니다', 'success');
            }
        }
        
        function updateTaggedProductsList() {
            const listDiv = document.getElementById('taggedProductsList');
            const taggedProducts = Object.keys(productTags).filter(key => productTags[key].length > 0);
            
            if (taggedProducts.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999;">아직 태그가 붙은 상품이 없습니다</p>';
                return;
            }
            
            listDiv.innerHTML = taggedProducts.map(model => {
                const product = products.find(p => p.model === model);
                if (!product) return '';
                
                return `
                    <div class="tagged-product-item">
                        <div class="tagged-product-info">
                            <div class="product-model">${product.model}</div>
                            <div class="product-name">${product.name}</div>
                            <div class="product-tag-badges">
                                ${productTags[model].map(tag => `
                                    <span class="tag-badge">
                                        ✨ ${tag}
                                        <span class="tag-remove" onclick="removeTagFromProduct('${model}', '${tag}')">×</span>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 브랜드 유의사항 함수들
        function loadNotesUI() {
            const brands = ['SK매직', 'LG전자', '코웨이', '교원웰스', '청호나이스', '쿠쿠', '세라젬'];
            const notesGrid = document.querySelector('.notes-grid');
            
            notesGrid.innerHTML = brands.map(brand => {
                const brandKey = brand.toLowerCase().replace(/[^a-z가-힣]/g, '');
                const savedNote = localStorage.getItem(`note_${brandKey}`) || '';
                const savedDate = localStorage.getItem(`note_${brandKey}_date`) || '';
                
                return `
                    <div class="note-card">
                        <div class="note-header">
                            <div class="note-brand">${brand}</div>
                            <div class="note-updated" id="note-${brandKey}-updated">${savedDate ? `수정: ${savedDate}` : ''}</div>
                        </div>
                        <textarea class="note-content" id="note-${brandKey}" placeholder="${brand} 관련 유의사항을 입력하세요...">${savedNote}</textarea>
                    </div>
                `;
            }).join('');
        }
        
        function saveNotes() {
            const brands = ['SK매직', 'LG전자', '코웨이', '교원웰스', '청호나이스', '쿠쿠', '세라젬'];
            const now = new Date().toLocaleDateString('ko-KR');
            
            brands.forEach(brand => {
                const brandKey = brand.toLowerCase().replace(/[^a-z가-힣]/g, '');
                const textarea = document.getElementById(`note-${brandKey}`);
                if (textarea) {
                    const content = textarea.value.trim();
                    if (content) {
                        localStorage.setItem(`note_${brandKey}`, content);
                        localStorage.setItem(`note_${brandKey}_date`, now);
                        document.getElementById(`note-${brandKey}-updated`).textContent = `수정: ${now}`;
                    }
                }
            });
            
            showToast('유의사항이 저장되었습니다', 'success');
        }
        
        // 타사보상 규정 함수들
        function loadCompetitorUI() {
            const brands = ['SK매직', 'LG전자', '코웨이', '교원웰스', '청호나이스', '쿠쿠', '세라젬'];
            const rulesGrid = document.querySelector('.competitor-rules-grid');
            
            rulesGrid.innerHTML = brands.map(brand => {
                const brandKey = brand.toLowerCase().replace(/[^a-z가-힣]/g, '');
                const savedRule = localStorage.getItem(`competitor_${brandKey}`) || '';
                const savedDate = localStorage.getItem(`competitor_${brandKey}_date`) || '';
                
                return `
                    <div class="competitor-rule-card">
                        <div class="competitor-rule-header">
                            <div class="competitor-rule-brand">${brand} 타사보상</div>
                            <div class="note-updated" id="competitor-${brandKey}-updated">${savedDate ? `수정: ${savedDate}` : ''}</div>
                        </div>
                        <textarea class="competitor-rule-content" id="competitor-${brandKey}" placeholder="${brand} 타사보상 규정을 입력하세요...
예: 
- 타사보상 적용 대상 및 조건
- 필요 서류 및 증빙 자료
- 위약금 면제 범위
- 프로모션 기간 및 제한사항">${savedRule}</textarea>
                    </div>
                `;
            }).join('');
        }
        
        function saveCompetitorRules() {
            const brands = ['SK매직', 'LG전자', '코웨이', '교원웰스', '청호나이스', '쿠쿠', '세라젬'];
            const now = new Date().toLocaleDateString('ko-KR');
            
            brands.forEach(brand => {
                const brandKey = brand.toLowerCase().replace(/[^a-z가-힣]/g, '');
                const textarea = document.getElementById(`competitor-${brandKey}`);
                if (textarea) {
                    const content = textarea.value.trim();
                    if (content) {
                        localStorage.setItem(`competitor_${brandKey}`, content);
                        localStorage.setItem(`competitor_${brandKey}_date`, now);
                        document.getElementById(`competitor-${brandKey}-updated`).textContent = `수정: ${now}`;
                    }
                }
            });
            
            showToast('타사보상 규정이 저장되었습니다', 'success');
        }
        
        // 제품 저장 (CRM 입력)
        async function saveProduct() {
            const crmText = document.getElementById('crmInput').value;
            
            if (!crmText.trim()) {
                showToast('데이터를 입력해주세요', 'error');
                return;
            }
            
            try {
                const parsed = parseCRMData(crmText);
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rental_products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(parsed)
                });
                
                if (response.ok) {
                    document.getElementById('crmInput').value = '';
                    showToast('제품이 성공적으로 저장되었습니다!', 'success');
                    await loadFromSupabase();
                } else {
                    const error = await response.text();
                    console.error('저장 실패:', error);
                    showToast('저장에 실패했습니다', 'error');
                }
            } catch (error) {
                console.error('파싱 오류:', error);
                showToast('데이터 형식이 올바르지 않습니다', 'error');
            }
        }
        
        // CRM 데이터 파싱
        function parseCRMData(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const product = {
                model: '',
                name: '',
                brand: '',
                url: '',
                options: []
            };
            
            lines.forEach(line => {
                line = line.trim();
                
                if (line.startsWith('* 모델명:')) {
                    product.model = line.replace('* 모델명:', '').trim();
                } else if (line.startsWith('* 제품명:')) {
                    const fullName = line.replace('* 제품명:', '').trim();
                    product.name = fullName;
                    
                    // 브랜드 추출
                    if (fullName.includes('SK매직')) product.brand = 'SK매직';
                    else if (fullName.includes('LG')) product.brand = 'LG전자';
                    else if (fullName.includes('코웨이')) product.brand = '코웨이';
                    else if (fullName.includes('웰스')) product.brand = '교원웰스';
                    else if (fullName.includes('청호')) product.brand = '청호나이스';
                    else if (fullName.includes('쿠쿠')) product.brand = '쿠쿠';
                    else if (fullName.includes('세라젬')) product.brand = '세라젬';
                    else product.brand = '기타';
                } else if (line.includes('약정:')) {
                    const parts = line.split('/').map(p => p.trim());
                    const period = parts[0].replace('*', '').trim().split(':')[0];
                    const management = parts[0].split(':')[1]?.trim() || '';
                    const price = parseInt(parts[1]?.replace(/[^0-9]/g, '') || 0);
                    const gift = parseInt(parts[2]?.replace(/[^0-9]/g, '') || 0);
                    
                    product.options.push({
                        period,
                        management,
                        price,
                        gift
                    });
                } else if (line.includes('상품 안내페이지')) {
                    product.url = line.split(':').slice(1).join(':').trim();
                }
            });
            
            return product;
        }
        
        // Supabase에서 데이터 로드
        async function loadFromSupabase() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rental_products`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    products = data;
                    
                    // 브랜드 순서 정의
                    const brandOrder = ['SK매직', 'LG전자', '코웨이', '교원웰스', '청호나이스', '쿠쿠', '세라젬', '기타'];
                    
                    // 브랜드별로 정렬
                    const sorted = products.sort((a, b) => {
                        const brandA = brandOrder.indexOf(a.brand);
                        const brandB = brandOrder.indexOf(b.brand);
                        
                        if (brandA !== brandB) {
                            return brandA - brandB;
                        }
                        
                        return a.model.localeCompare(b.model);
                    });
                    
                    renderProducts(sorted);
                    
                    updateProductSummary();
                    updateTaggedProductsList();
                    showToast(products.length + '개 제품 데이터 로드 완료!', 'success');
                } else {
                    console.error('데이터 로드 실패');
                    showToast('데이터 로드에 실패했습니다', 'error');
                }
            } catch (error) {
                console.error('로드 오류:', error);
                showToast('데이터 로드 중 오류가 발생했습니다', 'error');
            }
        }
        
        // 페이지 로드 시 초기화
        window.addEventListener('DOMContentLoaded', function() {
            // 태그 데이터 로드
            productTags = JSON.parse(localStorage.getItem('productTags') || '{}');
            
            // Supabase에서 데이터 로드
            loadFromSupabase();
            
            // 필터 이벤트 리스너 추가
            const filterCheckboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
            filterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => renderProducts(products));
            });
        });
    </script>
</body>
</html>
